param(
    [Parameter()]
    [ValidateSet("InMemory", "Kafka", "Hybrid")]
    [string]$Mode = "InMemory",
    
    [Parameter()]
    [switch]$Build,
    
    [Parameter()]
    [switch]$Stop,
    
    [Parameter()]
    [switch]$Logs
)

$ErrorActionPreference = "Stop"

# Navigate to docker directory
$dockerPath = Join-Path $PSScriptRoot "..\docker"
Push-Location $dockerPath

try {
    Write-Host "üöÄ DistributedQueue - Podman Deployment Script" -ForegroundColor Cyan
    Write-Host "=" * 60 -ForegroundColor Cyan
    
    # Check if Podman is installed
    Write-Host "`nüìã Checking Podman installation..." -ForegroundColor Yellow
    try {
        $podmanVersion = podman --version
        Write-Host "‚úÖ $podmanVersion" -ForegroundColor Green
    }
    catch {
        Write-Host "‚ùå Podman is not installed or not in PATH" -ForegroundColor Red
        Write-Host "Please install Podman Desktop from: https://podman-desktop.io/" -ForegroundColor Yellow
        exit 1
    }
    
    # Check if docker-compose/podman-compose is available
    Write-Host "`nüìã Checking compose tool..." -ForegroundColor Yellow
    $composeCmd = $null
    
    if (Get-Command "docker-compose" -ErrorAction SilentlyContinue) {
        $composeCmd = "docker-compose"
        Write-Host "‚úÖ Using docker-compose" -ForegroundColor Green
    }
    elseif (Get-Command "podman-compose" -ErrorAction SilentlyContinue) {
        $composeCmd = "podman-compose"
        Write-Host "‚úÖ Using podman-compose" -ForegroundColor Green
    }
    else {
        Write-Host "‚ùå Neither docker-compose nor podman-compose found" -ForegroundColor Red
        Write-Host "Podman Desktop usually includes docker-compose compatibility" -ForegroundColor Yellow
        Write-Host "You may need to start Podman Desktop or install podman-compose" -ForegroundColor Yellow
        exit 1
    }
    
    # Stop containers if requested
    if ($Stop) {
        Write-Host "`nüõë Stopping and removing containers..." -ForegroundColor Yellow
        & $composeCmd down -v
        Write-Host "‚úÖ Containers stopped and removed" -ForegroundColor Green
        Pop-Location
        return
    }
    
    # Check for .env file
    Write-Host "`nüìã Checking configuration..." -ForegroundColor Yellow
    if (Test-Path ".env") {
        Write-Host "‚úÖ Using existing .env file" -ForegroundColor Green
        
        # Read current mode from .env file
        $envContent = Get-Content ".env" -Raw
        if ($envContent -match "QueueMode__UseKafka=true" -and $envContent -match "QueueMode__UseInMemory=true") {
            Write-Host "üìù Current mode: Hybrid (Kafka + In-Memory)" -ForegroundColor Cyan
        }
        elseif ($envContent -match "QueueMode__UseKafka=true") {
            Write-Host "üìù Current mode: Kafka" -ForegroundColor Cyan
        }
        else {
            Write-Host "üìù Current mode: In-Memory" -ForegroundColor Cyan
        }
    }
    else {
        Write-Host "‚ùå .env file not found in docker/ folder" -ForegroundColor Red
        Write-Host "Please create .env file from .env.example:" -ForegroundColor Yellow
        Write-Host "  cd docker" -ForegroundColor Gray
        Write-Host "  Copy-Item .env.example .env" -ForegroundColor Gray
        Write-Host "  notepad .env" -ForegroundColor Gray
        exit 1
    }
    
    # Build if requested or if image doesn't exist
    if ($Build) {
        Write-Host "`nüî® Building container image..." -ForegroundColor Yellow
        & $composeCmd build --no-cache
        
        if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ùå Build failed" -ForegroundColor Red
            exit 1
        }
        Write-Host "‚úÖ Build completed" -ForegroundColor Green
    }
    
    # Start containers
    Write-Host "`nüöÄ Starting containers..." -ForegroundColor Yellow
    & $composeCmd up -d
    
    if ($LASTEXITCODE -ne 0) {
        Write-Host "‚ùå Failed to start containers" -ForegroundColor Red
        exit 1
    }
    
    Write-Host "‚úÖ Containers started successfully" -ForegroundColor Green
    
    # Wait for container to be healthy
    Write-Host "`n‚è≥ Waiting for API to be ready..." -ForegroundColor Yellow
    $maxRetries = 30
    $retryCount = 0
    $apiReady = $false
    
    while ($retryCount -lt $maxRetries) {
        try {
            $response = Invoke-WebRequest -Uri "http://localhost:8080/health" -Method Get -TimeoutSec 2 -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
                $apiReady = $true
                break
            }
        }
        catch {
            # API not ready yet
        }
        
        Start-Sleep -Seconds 2
        $retryCount++
        Write-Host "." -NoNewline
    }
    
    Write-Host ""
    
    if ($apiReady) {
        Write-Host "‚úÖ API is ready!" -ForegroundColor Green
    }
    else {
        Write-Host "‚ö†Ô∏è  API health check timed out, but container is running" -ForegroundColor Yellow
        Write-Host "Check logs with: $composeCmd logs -f" -ForegroundColor Yellow
    }
    
    # Show container status
    Write-Host "`nüìä Container Status:" -ForegroundColor Cyan
    & $composeCmd ps
    
    # Show access information
    Write-Host "`n" + ("=" * 60) -ForegroundColor Cyan
    Write-Host "‚úÖ Deployment Complete!" -ForegroundColor Green
    Write-Host ("=" * 60) -ForegroundColor Cyan
    Write-Host ""
    Write-Host "üìç API Endpoint: " -NoNewline -ForegroundColor Cyan
    Write-Host "http://localhost:8080" -ForegroundColor White
    Write-Host "üìç Swagger UI:   " -NoNewline -ForegroundColor Cyan
    Write-Host "http://localhost:8080/swagger" -ForegroundColor White
    Write-Host "üìç Health Check: " -NoNewline -ForegroundColor Cyan
    Write-Host "http://localhost:8080/health" -ForegroundColor White
    Write-Host ""
    Write-Host "üîß Mode: " -NoNewline -ForegroundColor Cyan
    Write-Host $Mode -ForegroundColor White
    Write-Host ""
    Write-Host "üìù Useful Commands:" -ForegroundColor Cyan
    Write-Host "  View logs:    $composeCmd logs -f" -ForegroundColor Gray
    Write-Host "  Stop:         $composeCmd down" -ForegroundColor Gray
    Write-Host "  Restart:      $composeCmd restart" -ForegroundColor Gray
    Write-Host "  Rebuild:      .\deploy-podman.ps1 -Build" -ForegroundColor Gray
    Write-Host ""
    
    # Show logs if requested
    if ($Logs) {
        Write-Host "üìã Showing logs (Ctrl+C to exit)..." -ForegroundColor Yellow
        & $composeCmd logs -f
    }
    
}
catch {
    Write-Host "`n‚ùå Deployment failed: $_" -ForegroundColor Red
    exit 1
}
finally {
    Pop-Location
}
